<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡¨åºŠæ•¸æ“šæ™ºæ…§åˆ†æå¹³å°</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ SheetJS è§£æ Excel/CSV -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- å¼•å…¥ Chart.js ç¹ªè£½åœ–è¡¨ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- å¼•å…¥ Chart.js DataLabels æ’ä»¶ (ç”¨æ–¼é¡¯ç¤ºæ¨™ç±¤) -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand-dark': '#0f172a',
                        'brand-blue': '#1e293b',
                        'brand-teal': '#0ea5e9',
                        'brand-teal-light': '#e0f2fe',
                        'brand-light-bg': '#f8fafc',
                    },
                    boxShadow: {
                        'soft': '0 10px 40px -10px rgba(0,0,0,0.05)',
                        'inner-soft': 'inset 0 2px 4px 0 rgba(0, 0, 0, 0.02)',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        
        body {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            font-family: 'Noto Sans TC', sans-serif;
        }
        .header-border {
            border-bottom: 3px solid #0ea5e9;
        }
        .logo-gradient {
            background: linear-gradient(135deg, #0ea5e9 0%, #3b82f6 100%);
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        /* è‡ªè¨‚æ²è»¸ */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
        
        /* Tab åˆ‡æ›å‹•ç•« */
        .chart-tab {
            position: relative;
            z-index: 1;
        }
        .chart-tab.active-tab {
            color: #0ea5e9;
        }
        .chart-tab.active-tab::before {
            content: '';
            position: absolute;
            inset: 0;
            background: white;
            border-radius: 9999px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            z-index: -1;
            transition: all 0.3s ease;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col text-slate-800">

    <!-- é ‚éƒ¨å°è¦½åˆ— -->
    <header class="bg-white header-border shadow-sm px-6 py-4 flex justify-between items-center shrink-0 sticky top-0 z-40">
        <div class="flex items-center gap-4">
            <!-- Logo åœ–ç¤º -->
            <div class="w-12 h-12 rounded-xl logo-gradient shadow-md flex items-center justify-center">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
            </div>
            <div>
                <h1 class="text-xl font-black text-slate-800 tracking-wide">è‡¨åºŠæ•¸æ“šæ™ºæ…§åˆ†æå¹³å°</h1>
                <p class="text-[11px] font-bold text-slate-400 tracking-widest mt-0.5 uppercase">Advanced Clinical Analytics BI</p>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <input type="file" id="fileInput" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" class="hidden" />
            
            <button onclick="document.getElementById('fileInput').click()" class="bg-slate-800 hover:bg-slate-900 text-white px-6 py-2.5 rounded-xl font-bold text-sm transition-all shadow-md hover:shadow-lg flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                è¼‰å…¥è‡¨åºŠæ•¸æ“šåº«
            </button>
            <button onclick="resetData()" class="bg-white border-2 border-slate-200 hover:border-slate-300 hover:bg-slate-50 text-slate-600 px-6 py-2.5 rounded-xl font-bold text-sm transition-all">
                é‡æ–°è¼¸å…¥
            </button>
        </div>
    </header>

    <!-- è¨Šæ¯æç¤ºæ¡† -->
    <div id="messageBox" class="fixed top-24 right-6 bg-white shadow-xl rounded-2xl border border-slate-100 p-4 max-w-sm hidden z-50 transition-all duration-300 opacity-0 translate-y-[-10px]">
        <div class="flex items-start gap-3">
            <div id="messageIcon" class="mt-0.5"></div>
            <div>
                <h4 id="messageTitle" class="text-sm font-black text-slate-800">æç¤º</h4>
                <p id="messageText" class="text-sm text-slate-500 mt-1 font-medium"></p>
            </div>
        </div>
    </div>

    <!-- ä¸»è¦å…§å®¹å€å¡Š -->
    <main class="flex-1 p-6 flex flex-col lg:flex-row gap-6 overflow-hidden max-w-[1600px] mx-auto w-full">
        
        <!-- å·¦å´é…ç½®æ¬„ -->
        <aside class="w-full lg:w-[340px] shrink-0 flex flex-col gap-6">
            <div class="glass-panel rounded-3xl shadow-soft p-6 flex flex-col">
                <h2 class="text-lg font-black text-slate-800 mb-6 flex items-center gap-2">
                    <span class="p-1.5 bg-brand-teal-light rounded-lg text-brand-teal">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                    </span>
                    æ ¸å¿ƒåˆ†æé…ç½®
                </h2>
                
                <div class="space-y-5">
                    <!-- åˆ†çµ„ç¶­åº¦ -->
                    <div>
                        <label class="block text-[11px] font-black text-slate-500 mb-2 tracking-widest uppercase">åˆ†çµ„ç¶­åº¦ (Variable X)</label>
                        <div class="relative">
                            <select id="variableSelect" onchange="updateChart()" disabled class="w-full appearance-none bg-slate-50 border border-slate-200 text-slate-700 py-3.5 px-4 rounded-xl focus:outline-none focus:bg-white focus:border-brand-teal focus:ring-2 focus:ring-brand-teal/20 transition-all disabled:opacity-50 disabled:cursor-not-allowed font-medium shadow-inner-soft">
                                <option value="">è«‹å…ˆè¼‰å…¥æ•¸æ“š...</option>
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-slate-400">
                                <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                            </div>
                        </div>
                    </div>

                    <!-- é¡¯ç¤ºæ ¼å¼ -->
                    <div>
                        <label class="block text-[11px] font-black text-slate-500 mb-2 tracking-widest uppercase">è³‡æ–™é¡¯ç¤ºæ ¼å¼ (Data Format)</label>
                        <div class="relative">
                            <select id="displayFormatSelect" onchange="updateChart()" disabled class="w-full appearance-none bg-slate-50 border border-slate-200 text-slate-700 py-3.5 px-4 rounded-xl focus:outline-none focus:bg-white focus:border-brand-teal focus:ring-2 focus:ring-brand-teal/20 transition-all disabled:opacity-50 disabled:cursor-not-allowed font-medium shadow-inner-soft">
                                <option value="count">æ•¸é‡ (Count)</option>
                                <option value="percentage">ç™¾åˆ†æ¯” (Percentage)</option>
                                <option value="both">æ•¸é‡èˆ‡ç™¾åˆ†æ¯”</option>
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-slate-400">
                                <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                            </div>
                        </div>
                    </div>

                    <!-- çµ±è¨ˆæŒ‡æ¨™ (å›ºå®š) -->
                    <div>
                        <label class="block text-[11px] font-black text-slate-500 mb-2 tracking-widest uppercase">çµ±è¨ˆæŒ‡æ¨™ (Metric Y)</label>
                        <div class="w-full bg-slate-50 border border-slate-200 text-slate-700 py-3.5 px-4 rounded-xl flex items-center gap-2 shadow-inner-soft">
                            <span class="text-rose-500">ğŸ“Œ</span>
                            <span class="font-bold text-sm">ç­†æ•¸åŠ ç¸½ (Count/Sum)</span>
                        </div>
                    </div>
                </div>

                <!-- ç¸½æ•¸é¡¯ç¤ºå¡ç‰‡ -->
                <div class="mt-8 bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-5 text-white shadow-lg relative overflow-hidden">
                    <div class="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-white opacity-5 rounded-full blur-xl"></div>
                    <p class="text-[11px] font-bold text-slate-400 tracking-widest uppercase mb-1">åˆ†æç¸½æ•¸ (Total Records)</p>
                    <div class="flex items-baseline gap-2">
                        <span id="totalCountDisplay" class="text-4xl font-black tracking-tight text-white">0</span>
                        <span class="text-sm font-medium text-slate-400">ç­†</span>
                    </div>
                </div>

            </div>
        </aside>

        <!-- å³å´åœ–è¡¨å€ -->
        <section class="glass-panel rounded-3xl shadow-soft flex-1 flex flex-col relative overflow-hidden border border-white/60">
            
            <!-- åœ–è¡¨å·¥å…·åˆ— -->
            <div class="px-8 pt-6 pb-4 flex flex-col sm:flex-row justify-between items-center z-10 relative gap-4 border-b border-slate-100">
                
                <!-- åœ–è¡¨é¡å‹åˆ‡æ› Tabs -->
                <div class="bg-slate-100/80 p-1.5 rounded-full flex gap-1 shadow-inner-soft border border-slate-200/60 overflow-x-auto w-full sm:w-auto">
                    <button onclick="setChartType('bar', this)" class="chart-tab active-tab px-6 py-2 rounded-full text-sm font-bold text-slate-500 hover:text-slate-800 transition-all whitespace-nowrap">
                        ç›´æ¢åœ–
                    </button>
                    <button onclick="setChartType('horizontalBar', this)" class="chart-tab px-6 py-2 rounded-full text-sm font-bold text-slate-500 hover:text-slate-800 transition-all whitespace-nowrap">
                        æ©«æ¢åœ–
                    </button>
                    <button onclick="setChartType('line', this)" class="chart-tab px-6 py-2 rounded-full text-sm font-bold text-slate-500 hover:text-slate-800 transition-all whitespace-nowrap">
                        è¶¨å‹¢åœ–
                    </button>
                    <button onclick="setChartType('pie', this)" class="chart-tab px-6 py-2 rounded-full text-sm font-bold text-slate-500 hover:text-slate-800 transition-all whitespace-nowrap">
                        åœ“é¤…åœ–
                    </button>
                </div>

                <!-- åŒ¯å‡ºæŒ‰éˆ• -->
                <button onclick="exportChart()" id="exportBtn" disabled class="bg-brand-teal hover:bg-sky-600 disabled:opacity-50 disabled:cursor-not-allowed text-white px-6 py-2.5 rounded-xl font-bold text-sm transition-all shadow-md hover:shadow-lg flex items-center gap-2 shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                    åŒ¯å‡ºå ±è¡¨ (JPG)
                </button>
            </div>

            <!-- ç•«å¸ƒ/ä½”ä½ç¬¦å€åŸŸ -->
            <div class="flex-1 flex items-center justify-center p-8 relative min-h-[400px]">
                <!-- åˆå§‹ä½”ä½æç¤º -->
                <div id="placeholder" class="text-center transition-opacity duration-300">
                    <div class="w-24 h-24 mx-auto mb-6 bg-slate-100 rounded-full flex items-center justify-center">
                        <svg class="w-12 h-12 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    </div>
                    <h3 class="text-xl font-black text-slate-400 mb-2">ç­‰å¾…è¼‰å…¥åˆ†ææ•¸æ“š</h3>
                    <p class="text-slate-400 text-sm font-medium">è«‹é»æ“Šä¸Šæ–¹ã€Œè¼‰å…¥è‡¨åºŠæ•¸æ“šåº«ã€æŒ‰éˆ•é–‹å§‹</p>
                </div>

                <!-- Chart.js ç•«å¸ƒå®¹å™¨ -->
                <div id="chartContainer" class="w-full h-full absolute inset-0 p-8 pt-4 hidden opacity-0 transition-opacity duration-500 flex items-center justify-center">
                    <canvas id="myChart"></canvas>
                </div>
            </div>
            
        </section>
    </main>

    <script>
        // è¨»å†Š ChartDataLabels æ’ä»¶
        Chart.register(ChartDataLabels);
        
        // å…¨åŸŸè®Šæ•¸
        let rawData = [];
        let headers = [];
        let currentChartType = 'bar'; // 'bar', 'horizontalBar', 'line', 'pie'
        let chartInstance = null;
        let currentTotalCount = 0;

        // Chart.js è¨»å†Šè‡ªè¨‚èƒŒæ™¯æ’ä»¶ (ç¢ºä¿åŒ¯å‡º JPG æ™‚èƒŒæ™¯æ˜¯ç™½è‰²)
        const customCanvasBackgroundColor = {
            id: 'customCanvasBackgroundColor',
            beforeDraw: (chart, args, options) => {
                const {ctx} = chart;
                ctx.save();
                ctx.globalCompositeOperation = 'destination-over';
                ctx.fillStyle = options.color || '#ffffff';
                ctx.fillRect(0, 0, chart.width, chart.height);
                ctx.restore();
            }
        };
        Chart.register(customCanvasBackgroundColor);

        // ç›£è½æª”æ¡ˆä¸Šå‚³
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const fileExt = file.name.split('.').pop().toLowerCase();
            if (!['csv', 'xlsx', 'xls'].includes(fileExt)) {
                showMessage('æª”æ¡ˆæ ¼å¼éŒ¯èª¤', 'è«‹ä¸Šå‚³æœ‰æ•ˆçš„ Excel (.xlsx, .xls) æˆ– CSV æª”æ¡ˆã€‚', 'error');
                return;
            }

            showMessage('è³‡æ–™è¼‰å…¥ä¸­', `æ­£åœ¨è®€å–åŠè§£æ: ${file.name}...`, 'info');

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1, defval: null});
                    
                    if (jsonData.length < 2) {
                        showMessage('è³‡æ–™ç‚ºç©º', 'æª”æ¡ˆå…§å®¹ç‚ºç©ºæˆ–ç¼ºå°‘æ•¸æ“šåˆ—ã€‚', 'error');
                        return;
                    }

                    headers = jsonData[0];
                    rawData = jsonData.slice(1).filter(row => row.some(cell => cell !== null && cell !== ''));

                    // æ›´æ–° UI ç‹€æ…‹
                    document.getElementById('displayFormatSelect').disabled = false;
                    populateDropdown();
                    showMessage('è¼‰å…¥æˆåŠŸ', `å·²æˆåŠŸè§£æ ${rawData.length} ç­†æœ‰æ•ˆè¨˜éŒ„ã€‚`, 'success');
                    
                    // åˆ‡æ›ç•«é¢é¡¯ç¤º
                    document.getElementById('placeholder').style.opacity = '0';
                    setTimeout(() => {
                        document.getElementById('placeholder').classList.add('hidden');
                        document.getElementById('chartContainer').classList.remove('hidden');
                        setTimeout(() => {
                            document.getElementById('chartContainer').style.opacity = '1';
                        }, 50);
                    }, 300);

                    document.getElementById('exportBtn').disabled = false;

                } catch (error) {
                    console.error(error);
                    showMessage('è§£æå¤±æ•—', 'è®€å–æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¢ºèªæª”æ¡ˆå…§å®¹æ˜¯å¦ææ¯€ã€‚', 'error');
                }
            };
            reader.readAsArrayBuffer(file);
            e.target.value = '';
        });

        // å¡«å……ä¸‹æ‹‰é¸å–®
        function populateDropdown() {
            const select = document.getElementById('variableSelect');
            select.innerHTML = '';
            
            headers.forEach((header, index) => {
                const optionText = header ? header.toString().trim() : `æœªå‘½åæ¬„ä½ ${index + 1}`;
                if (optionText) {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = optionText;
                    select.appendChild(option);
                }
            });

            select.disabled = false;
            updateChart();
        }

        // å‹•æ…‹ç”Ÿæˆä¸é‡è¤‡çš„é¡è‰² (åˆ©ç”¨é»ƒé‡‘æ¯”ä¾‹åˆ†æ•£è‰²ç›¸)
        function generateUniqueColors(count) {
            const colors = [];
            // é»ƒé‡‘æ¯”ä¾‹å…±è»›è§’åº¦ç´„ç‚º 137.508 åº¦ï¼Œèƒ½ç¢ºä¿ç”Ÿæˆçš„é¡è‰²åœ¨è‰²ç›¸ç’°ä¸Šå‡å‹»ä¸”ä¸é‡è¤‡
            for (let i = 0; i < count; i++) {
                const hue = (i * 137.508) % 360; 
                // é£½å’Œåº¦ 75%, äº®åº¦ 55%ï¼Œç¢ºä¿é¡è‰²é®®æ˜ä¸”ä¸åˆºçœ¼
                colors.push(`hsla(${hue}, 75%, 55%, 0.85)`);
            }
            return colors;
        }

        // ä¾æ“šé¸æ“‡çš„ç¶­åº¦å½™æ•´æ•¸æ“š
        function getAggregatedData(columnIndex) {
            const counts = {};
            currentTotalCount = 0; // é‡ç½®ç¸½æ•¸è¨ˆç®—

            rawData.forEach(row => {
                let val = row[columnIndex];
                val = (val === null || val === undefined || val === '') ? '(ç©ºç™½/æœªå¡«)' : val.toString().trim();
                counts[val] = (counts[val] || 0) + 1;
                currentTotalCount++; // è¨ˆç®—ç¸½ç­†æ•¸
            });

            // æ›´æ–°å·¦å´ç¸½æ•¸é¡¯ç¤ºå¡ç‰‡ (å¸¶æœ‰åƒåˆ†ä½)
            document.getElementById('totalCountDisplay').textContent = currentTotalCount.toLocaleString();

            const sortedData = Object.entries(counts).sort((a, b) => b[1] - a[1]);
            
            let finalLabels = [];
            let finalData = [];
            
            // é¡åˆ¥éå¤šæ™‚åˆä½µç‚ºã€Œå…¶ä»–ã€
            if (sortedData.length > 25 && currentChartType !== 'line') {
                const topItems = sortedData.slice(0, 15);
                const others = sortedData.slice(15);
                const othersCount = others.reduce((sum, item) => sum + item[1], 0);
                
                finalLabels = topItems.map(item => item[0]);
                finalData = topItems.map(item => item[1]);
                
                finalLabels.push(`å…¶ä»– (${others.length} é …)`);
                finalData.push(othersCount);
            } else {
                finalLabels = sortedData.map(item => item[0]);
                finalData = sortedData.map(item => item[1]);
            }

            return { labels: finalLabels, data: finalData };
        }

        // æ ¼å¼åŒ–æ•¸å€¼èˆ‡ç™¾åˆ†æ¯”å­—ä¸²
        function formatLabelValue(value, total) {
            const formatType = document.getElementById('displayFormatSelect').value;
            const percentage = ((value / total) * 100).toFixed(1) + '%';
            
            if (formatType === 'percentage') return percentage;
            if (formatType === 'both') return `${value} (${percentage})`;
            return value; // é è¨­ count
        }

        // æ›´æ–°åœ–è¡¨
        function updateChart() {
            const select = document.getElementById('variableSelect');
            if (select.value === '' || rawData.length === 0) return;

            const columnIndex = parseInt(select.value, 10);
            const variableName = select.options[select.selectedIndex].text;
            const chartData = getAggregatedData(columnIndex);

            drawChart(variableName, chartData.labels, chartData.data);
        }

        // ç¹ªè£½/é‡ç¹ª Chart.js
        function drawChart(labelName, labels, data) {
            const ctx = document.getElementById('myChart').getContext('2d');
            
            if (chartInstance) {
                chartInstance.destroy();
            }

            let actualType = currentChartType;
            let indexAxis = 'x';
            
            if (currentChartType === 'horizontalBar') {
                actualType = 'bar';
                indexAxis = 'y';
            }

            // æ±ºå®šé¡è‰²é…ç½®ï¼šåœ“é¤…åœ–ä½¿ç”¨å‹•æ…‹ç”Ÿæˆçš„ä¸é‡è¤‡é¡è‰²ï¼Œæ¢åœ–/ç·šåœ–ä½¿ç”¨å“ç‰Œä¸»è‰²
            const bgColors = actualType === 'pie' 
                            ? generateUniqueColors(data.length) 
                            : 'rgba(14, 165, 233, 0.85)'; // Tailwind brand-teal

            const config = {
                type: actualType,
                data: {
                    labels: labels,
                    datasets: [{
                        label: `æ•¸é‡`,
                        data: data,
                        backgroundColor: bgColors,
                        borderColor: actualType === 'line' ? '#0ea5e9' : (actualType === 'pie' ? '#ffffff' : 'transparent'),
                        borderWidth: actualType === 'pie' ? 2 : (actualType === 'line' ? 3 : 0),
                        tension: 0.3,
                        borderRadius: (actualType === 'bar' && currentChartType !== 'horizontalBar') ? {topLeft: 6, topRight: 6} : (currentChartType === 'horizontalBar' ? {topRight: 6, bottomRight: 6} : 0),
                        fill: actualType === 'line' ? { target: 'origin', above: 'rgba(14, 165, 233, 0.1)' } : false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: indexAxis,
                    layout: {
                        padding: { top: 20, right: 30, bottom: 10, left: 10 }
                    },
                    plugins: {
                        legend: {
                            display: actualType === 'pie',
                            position: 'right',
                            labels: {
                                font: { family: "'Noto Sans TC', sans-serif", weight: 'bold' },
                                padding: 20,
                                usePointStyle: true,
                            }
                        },
                        title: {
                            display: true,
                            text: `ç¶­åº¦çµ±è¨ˆåˆ†ä½ˆï¼š${labelName}`,
                            font: { size: 20, family: "'Noto Sans TC', sans-serif", weight: '900' },
                            padding: { top: 10, bottom: 30 },
                            color: '#1e293b'
                        },
                        customCanvasBackgroundColor: { color: 'white' },
                        // DataLabels é¡¯ç¤ºè¨­å®š
                        datalabels: {
                            display: actualType !== 'line', // ç·šåœ–é è¨­ä¸é¡¯ç¤ºæ–‡å­—ä»¥å…å¤ªæ“æ“ 
                            color: actualType === 'pie' ? '#ffffff' : '#475569',
                            anchor: actualType === 'pie' ? 'center' : 'end',
                            align: actualType === 'pie' ? 'center' : (currentChartType === 'horizontalBar' ? 'right' : 'top'),
                            offset: actualType === 'pie' ? 0 : 4,
                            font: {
                                weight: 'bold',
                                family: "'Noto Sans TC', sans-serif",
                                size: 12
                            },
                            formatter: (value, context) => {
                                // è‹¥æ•¸å€¼å¤ªå°åœ¨åœ“é¤…åœ–ä¸­ä¸é¡¯ç¤ºæ¨™ç±¤ä»¥å…é‡ç–Š (ä½æ–¼ 2.5%)
                                if (actualType === 'pie' && (value / currentTotalCount) < 0.025) {
                                    return null;
                                }
                                return formatLabelValue(value, currentTotalCount);
                            },
                            // æ›¿åœ“é¤…åœ–çš„æ–‡å­—åŠ ä¸Šé™°å½±ï¼Œå¢åŠ å¯è®€æ€§
                            textShadowBlur: actualType === 'pie' ? 4 : 0,
                            textShadowColor: actualType === 'pie' ? 'rgba(0,0,0,0.5)' : 'transparent'
                        },
                        // Tooltip æ‡¸æµ®æç¤ºæ¡†è¨­å®š
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.9)',
                            titleFont: { family: "'Noto Sans TC', sans-serif", size: 14 },
                            bodyFont: { family: "'Noto Sans TC', sans-serif", size: 13, weight: 'bold' },
                            padding: 12,
                            cornerRadius: 8,
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const label = context.dataset.label || '';
                                    return ` ${label} : ${formatLabelValue(value, currentTotalCount)}`;
                                }
                            }
                        }
                    },
                    scales: actualType === 'pie' ? {} : {
                        x: {
                            grid: { display: false },
                            ticks: { 
                                maxRotation: 45, minRotation: 0,
                                font: { family: "'Noto Sans TC', sans-serif", weight: '500' }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: { color: '#f1f5f9', borderDash: [5, 5] },
                            ticks: { 
                                stepSize: 1,
                                font: { family: "'Noto Sans TC', sans-serif", weight: '500' }
                            }
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeOutQuart'
                    }
                }
            };

            chartInstance = new Chart(ctx, config);
        }

        // åˆ‡æ›åœ–è¡¨é¡å‹
        function setChartType(type, btnElement) {
            currentChartType = type;
            
            const tabs = document.querySelectorAll('.chart-tab');
            tabs.forEach(tab => {
                tab.classList.remove('active-tab');
            });
            
            btnElement.classList.add('active-tab');
            updateChart();
        }

        // åŒ¯å‡ºåœ–è¡¨ç‚º JPG
        function exportChart() {
            if (!chartInstance) return;
            
            const btn = document.getElementById('exportBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'è™•ç†ä¸­...';
            btn.disabled = true;

            try {
                const url_base64jp = document.getElementById("myChart").toDataURL("image/jpeg", 1.0);
                const a = document.createElement('a');
                const select = document.getElementById('variableSelect');
                const varName = select.options[select.selectedIndex].text;
                
                a.href = url_base64jp;
                a.download = `åˆ†æå ±è¡¨_${varName}.jpg`;
                a.click();
                
                showMessage('åŒ¯å‡ºæˆåŠŸ', 'å ±è¡¨å·²æˆåŠŸå„²å­˜ç‚º JPG åœ–ç‰‡ã€‚', 'success');
            } catch (error) {
                console.error(error);
                showMessage('åŒ¯å‡ºå¤±æ•—', 'ç„¡æ³•åŒ¯å‡ºåœ–è¡¨ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚', 'error');
            } finally {
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 1000);
            }
        }

        // é‡æ–°è¼¸å…¥ (é‡ç½®è³‡æ–™)
        function resetData() {
            rawData = [];
            headers = [];
            currentTotalCount = 0;
            
            if (chartInstance) {
                chartInstance.destroy();
                chartInstance = null;
            }

            // é‡ç½® UI
            const select = document.getElementById('variableSelect');
            select.innerHTML = '<option value="">è«‹å…ˆè¼‰å…¥æ•¸æ“š...</option>';
            select.disabled = true;
            
            const formatSelect = document.getElementById('displayFormatSelect');
            formatSelect.value = 'count';
            formatSelect.disabled = true;

            document.getElementById('exportBtn').disabled = true;
            document.getElementById('totalCountDisplay').textContent = '0';
            
            document.getElementById('chartContainer').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('chartContainer').classList.add('hidden');
                document.getElementById('placeholder').classList.remove('hidden');
                setTimeout(() => {
                    document.getElementById('placeholder').style.opacity = '1';
                }, 50);
            }, 300);

            const firstTab = document.querySelector('.chart-tab');
            setChartType('bar', firstTab);

            showMessage('ç³»çµ±é‡ç½®', 'è³‡æ–™å·²æ¸…é™¤ï¼Œç­‰å¾…é‡æ–°è¼‰å…¥ã€‚', 'info');
        }

        // å®¢è£½åŒ–è¨Šæ¯æ¡†
        function showMessage(title, text, type = 'info') {
            const box = document.getElementById('messageBox');
            const titleEl = document.getElementById('messageTitle');
            const textEl = document.getElementById('messageText');
            const iconEl = document.getElementById('messageIcon');

            titleEl.textContent = title;
            textEl.textContent = text;

            let iconHtml = '';
            if (type === 'success') {
                iconHtml = '<svg class="text-emerald-500 w-5 h-5 drop-shadow-sm" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>';
            } else if (type === 'error') {
                iconHtml = '<svg class="text-rose-500 w-5 h-5 drop-shadow-sm" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>';
            } else {
                iconHtml = '<svg class="text-sky-500 w-5 h-5 drop-shadow-sm" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>';
            }
            iconEl.innerHTML = iconHtml;

            box.classList.remove('hidden');
            void box.offsetWidth; 
            box.classList.remove('opacity-0', 'translate-y-[-10px]');

            setTimeout(hideMessage, 4000);
        }

        function hideMessage() {
            const box = document.getElementById('messageBox');
            box.classList.add('opacity-0', 'translate-y-[-10px]');
            setTimeout(() => {
                box.classList.add('hidden');
            }, 300);
        }

    </script>
</body>
</html>